"""
Professional Stock Market AI Decision Support System
Educational purposes only - Not financial advice
"""

import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime

# Import custom modules
from utils.data_handler import fetch_stock_data, get_stock_info, calculate_price_change
from utils.indicators import add_all_indicators, get_indicator_summary
from utils.signals import generate_trading_signal, format_signal_display, get_signal_color
from utils.model_utils import (
    load_trained_model, predict_next_price, predict_multiple_days,
    evaluate_model_on_recent_data, format_metrics_display
)
from utils.visualizations import (
    create_candlestick_chart, create_rsi_chart, create_macd_chart,
    create_prediction_chart, create_actual_vs_predicted_chart
)

# Page configuration
st.set_page_config(
    page_title="AI Stock Analysis Dashboard",
    page_icon="üìà",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Constants
TIME_STEPS = 60
DEFAULT_SYMBOL = "RELIANCE.NS"

# Custom CSS for better styling
st.markdown("""
<style>
    .main-header {
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        padding: 1rem 0;
    }
    .disclaimer-box {
        background-color: #fef3c7;
        color: #92400e;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid #f59e0b;
        margin: 1rem 0;
    }
    .metric-card {
        background-color: #1e293b;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 0.5rem 0;
    }
    .signal-buy {
        background-color: #065f46;
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
    }
    .signal-sell {
        background-color: #991b1b;
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
    }
    .signal-hold {
        background-color: #92400e;
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
    }
</style>
""", unsafe_allow_html=True)


@st.cache_resource
def load_model():
    """Load the pre-trained LSTM model and scaler"""
    return load_trained_model()


def display_disclaimer():
    """Display educational disclaimer"""
    st.markdown("""
    <div class="disclaimer-box">
        <h3>‚ö†Ô∏è EDUCATIONAL DISCLAIMER</h3>
        <p><strong>This tool is for educational and research purposes only.</strong></p>
        <p>This is NOT financial advice. The predictions and signals generated by this system 
        should not be used as the sole basis for investment decisions. Always consult with a 
        qualified financial advisor before making investment decisions. Past performance does 
        not guarantee future results. Investing in stocks carries risk, including the potential 
        loss of principal.</p>
    </div>
    """, unsafe_allow_html=True)


def display_stock_header(stock_info, price_stats):
    """Display stock information header"""
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            label=f"{stock_info['symbol']}",
            value=f"${price_stats['current_price']:.2f}",
            delta=f"{price_stats['day_change_pct']:.2f}%"
        )
    
    with col2:
        st.metric(
            label="Day Change",
            value=f"${price_stats['day_change']:.2f}",
            delta=f"{price_stats['day_change_pct']:.2f}%"
        )
    
    with col3:
        st.metric(
            label="Period High",
            value=f"${price_stats['period_high']:.2f}"
        )
    
    with col4:
        st.metric(
            label="Period Low",
            value=f"${price_stats['period_low']:.2f}"
        )
    
    # Additional info
    st.caption(f"**Company:** {stock_info['name']} | **Sector:** {stock_info['sector']} | **Exchange:** {stock_info['exchange']}")


def main():
    # Header
    st.markdown('<h1 class="main-header">üìà AI Stock Market Analysis Dashboard</h1>', unsafe_allow_html=True)
    st.markdown("### Professional Decision Support System powered by LSTM Neural Networks")
    
    # Display disclaimer
    display_disclaimer()
    
    # Sidebar configuration
    st.sidebar.header("‚öôÔ∏è Configuration")
    
    # Stock symbol input
    stock_symbol = st.sidebar.text_input(
        "Enter Stock Symbol",
        value=DEFAULT_SYMBOL,
        help="Examples: AAPL, GOOGL, TSLA, RELIANCE.NS, TCS.NS"
    ).upper()
    
    # Period selection
    period = st.sidebar.selectbox(
        "Select Data Period",
        options=["6mo", "1y", "2y", "5y", "10y"],
        index=2,
        help="Historical data period to fetch and analyze"
    )
    
    # Analysis options
    st.sidebar.subheader("Analysis Options")
    show_volume = st.sidebar.checkbox("Show Volume", value=True)
    show_indicators = st.sidebar.checkbox("Show Technical Indicators", value=True)
    show_multi_day = st.sidebar.checkbox("Show 5-Day Forecast", value=False)
    evaluate_model = st.sidebar.checkbox("Show Model Performance Metrics", value=True)
    
    # Analyze button
    analyze_button = st.sidebar.button("üöÄ Analyze Stock", type="primary", use_container_width=True)
    
    # Main analysis
    if analyze_button:
        with st.spinner(f"Fetching data for {stock_symbol}..."):
            # Fetch data
            df = fetch_stock_data(stock_symbol, period=period)
            
            if df is None or len(df) == 0:
                st.error(f"‚ùå Unable to fetch data for symbol '{stock_symbol}'. Please check the symbol and try again.")
                return
            
            if len(df) < TIME_STEPS:
                st.error(f"‚ùå Insufficient data points ({len(df)}). Need at least {TIME_STEPS} data points. Try a longer period.")
                return
        
        with st.spinner("Loading AI model and calculating indicators..."):
            # Load model
            model, scaler = load_model()
            
            # Get stock info
            stock_info = get_stock_info(stock_symbol)
            
            # Calculate technical indicators
            df_with_indicators = add_all_indicators(df)
            
            # Calculate price statistics
            price_stats = calculate_price_change(df_with_indicators)
            
            # Get indicator summary
            indicators = get_indicator_summary(df_with_indicators)
        
        # Display stock header
        display_stock_header(stock_info, price_stats)
        
        st.markdown("---")
        
        # Main layout: Chart on left, Analysis on right
        col_chart, col_analysis = st.columns([2, 1])
        
        with col_chart:
            st.subheader("üìä Price Chart")
            
            # Create and display candlestick chart
            fig_candle = create_candlestick_chart(
                df_with_indicators.tail(200),  # Show last 200 days for better visibility
                stock_symbol,
                show_volume=show_volume,
                show_ma=show_indicators
            )
            st.plotly_chart(fig_candle, use_container_width=True)
        
        with col_analysis:
            st.subheader("ü§ñ AI Prediction")
            
            # Make prediction
            with st.spinner("Generating prediction..."):
                predicted_price = predict_next_price(
                    model, scaler, df['Close'].values, TIME_STEPS
                )
                
                current_price = df['Close'].iloc[-1]
                price_change = predicted_price - current_price
                price_change_pct = (price_change / current_price) * 100
            
            # Display prediction
            st.metric(
                label="Predicted Next Close Price",
                value=f"${predicted_price:.2f}",
                delta=f"{price_change_pct:.2f}%"
            )
            
            # Multi-day forecast
            if show_multi_day:
                with st.spinner("Generating 5-day forecast..."):
                    multi_day_pred = predict_multiple_days(
                        model, scaler, df['Close'].values, TIME_STEPS, days=5
                    )
                    st.write("**5-Day Forecast:**")
                    for i, price in enumerate(multi_day_pred, 1):
                        st.write(f"Day {i}: ${price:.2f}")
            
            st.markdown("---")
            
            # Trading Signal
            st.subheader("üéØ Trading Signal")
            
            with st.spinner("Analyzing signals..."):
                signal_data = generate_trading_signal(
                    indicators, predicted_price, current_price
                )
            
            # Display signal with color coding
            signal = signal_data['signal']
            confidence = signal_data['confidence']
            
            signal_class = f"signal-{signal.lower()}"
            st.markdown(
                f'<div class="{signal_class}">{signal_data["signal"]} - Confidence: {confidence}</div>',
                unsafe_allow_html=True
            )
            
            st.markdown("---")
            
            # Signal explanation
            with st.expander("üìã Detailed Analysis", expanded=True):
                st.markdown(signal_data['summary'])
                st.markdown("\n**Signal Breakdown:**")
                for explanation in signal_data['explanations']:
                    st.markdown(f"- {explanation}")
        
        # Technical Indicators Section
        if show_indicators:
            st.markdown("---")
            st.subheader("üìà Technical Indicators")
            
            col_rsi, col_macd = st.columns(2)
            
            with col_rsi:
                fig_rsi = create_rsi_chart(df_with_indicators.tail(100))
                st.plotly_chart(fig_rsi, use_container_width=True)
            
            with col_macd:
                fig_macd = create_macd_chart(df_with_indicators.tail(100))
                st.plotly_chart(fig_macd, use_container_width=True)
            
            # Indicator values
            st.markdown("**Current Indicator Values:**")
            ind_col1, ind_col2, ind_col3, ind_col4 = st.columns(4)
            
            with ind_col1:
                if 'RSI' in indicators:
                    st.metric("RSI", f"{indicators['RSI']:.2f}")
            
            with ind_col2:
                if 'SMA_20' in indicators:
                    st.metric("SMA 20", f"${indicators['SMA_20']:.2f}")
            
            with ind_col3:
                if 'SMA_50' in indicators:
                    st.metric("SMA 50", f"${indicators['SMA_50']:.2f}")
            
            with ind_col4:
                if 'MACD' in indicators:
                    st.metric("MACD", f"{indicators['MACD']:.2f}")
        
        # Prediction Visualization
        st.markdown("---")
        st.subheader("üîÆ Prediction Visualization")
        
        fig_pred = create_prediction_chart(
            df_with_indicators.tail(60),
            predicted_price,
            multi_day_pred if show_multi_day else None
        )
        st.plotly_chart(fig_pred, use_container_width=True)
        
        # Model Performance Metrics
        if evaluate_model:
            st.markdown("---")
            st.subheader("üìä Model Performance Evaluation")
            
            with st.spinner("Evaluating model performance on recent data..."):
                eval_result = evaluate_model_on_recent_data(
                    model, scaler, df_with_indicators, TIME_STEPS, test_days=30
                )
            
            if eval_result:
                col_metrics, col_chart = st.columns([1, 2])
                
                with col_metrics:
                    metrics_display = format_metrics_display(eval_result['metrics'])
                    st.markdown(metrics_display)
                
                with col_chart:
                    fig_comparison = create_actual_vs_predicted_chart(
                        eval_result['actuals'][-20:],  # Show last 20 comparisons
                        eval_result['predictions'][-20:]
                    )
                    st.plotly_chart(fig_comparison, use_container_width=True)
            else:
                st.info("Not enough historical data to evaluate model performance.")
        
        # Data Information
        with st.expander("‚ÑπÔ∏è Data Information"):
            st.write(f"**Total Data Points:** {len(df_with_indicators)}")
            st.write(f"**Date Range:** {df_with_indicators.index[0].strftime('%Y-%m-%d')} to {df_with_indicators.index[-1].strftime('%Y-%m-%d')}")
            st.write(f"**Average Daily Volume:** {price_stats['avg_volume']:,.0f}")
            st.write(f"**Period Return:** {price_stats['period_change_pct']:.2f}%")
    
    else:
        # Initial state - show welcome message
        st.info("üëà Configure your analysis settings in the sidebar and click 'Analyze Stock' to begin.")
        
        st.markdown("""
        ### Features of this AI-Powered Dashboard:
        
        - **üìä Professional Candlestick Charts** with volume and moving averages
        - **ü§ñ LSTM Neural Network Predictions** for next-day price forecasting
        - **üìà Technical Indicators** including RSI, MACD, SMA, EMA
        - **üéØ AI-Assisted Trading Signals** with explainable Buy/Sell/Hold recommendations
        - **üìä Model Performance Metrics** including RMSE, MAE, and directional accuracy
        - **üîÆ Multi-Day Forecasting** capability
        - **‚ö†Ô∏è Educational Focus** with clear disclaimers and responsible AI usage
        
        ### How to Use:
        1. Enter a stock symbol (e.g., AAPL, GOOGL, RELIANCE.NS)
        2. Select the historical data period
        3. Choose analysis options
        4. Click "Analyze Stock" to generate comprehensive analysis
        
        ### Popular Stock Symbols:
        - **US Stocks:** AAPL, GOOGL, MSFT, TSLA, AMZN, NVDA
        - **Indian Stocks:** RELIANCE.NS, TCS.NS, INFY.NS, HDFCBANK.NS, ITC.NS
        """)
    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style="text-align: center; color: gray; padding: 1rem;">
        <p>Built with Streamlit ‚Ä¢ Powered by TensorFlow LSTM ‚Ä¢ Educational Project</p>
        <p>‚ö†Ô∏è Not financial advice ‚Ä¢ For educational purposes only ‚Ä¢ Always do your own research</p>
    </div>
    """, unsafe_allow_html=True)


if __name__ == "__main__":
    main()
