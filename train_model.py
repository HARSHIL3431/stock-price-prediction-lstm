# -*- coding: utf-8 -*-
"""train_model.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Vd2uzApZB5aQaLuh4ziQ6hekTFB8ogHm
"""

!pip install yfinance tensorflow scikit-learn joblib pandas numpy

# train_model.py
import numpy as np
import pandas as pd
import yfinance as yf
from sklearn.preprocessing import MinMaxScaler
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense, Dropout
import joblib  # for saving scaler

STOCK_SYMBOL = "RELIANCE.NS"
START_DATE = "2015-01-01"
END_DATE = "2024-12-31"
TIME_STEPS = 60

def load_data(symbol, start, end):
    data = yf.download(symbol, start=start, end=end)
    close_prices = data[["Close"]].dropna()
    return close_prices

def create_sequences(dataset, time_steps=1):
    X, y = [], []
    for i in range(time_steps, len(dataset)):
        X.append(dataset[i-time_steps:i, 0])
        y.append(dataset[i, 0])
    return np.array(X), np.array(y)

def build_model(time_steps):
    model = Sequential()
    model.add(LSTM(units=50, return_sequences=True, input_shape=(time_steps, 1)))
    model.add(Dropout(0.2))
    model.add(LSTM(units=50, return_sequences=False))
    model.add(Dropout(0.2))
    model.add(Dense(units=25))
    model.add(Dense(units=1))
    model.compile(optimizer="adam", loss="mean_squared_error")
    return model

def main():
    print(f"Downloading data for {STOCK_SYMBOL}...")
    close_prices = load_data(STOCK_SYMBOL, START_DATE, END_DATE)
    print("Data points:", len(close_prices))

    scaler = MinMaxScaler(feature_range=(0, 1))
    scaled_close = scaler.fit_transform(close_prices)

    X, y = create_sequences(scaled_close, TIME_STEPS)
    X = X.reshape(X.shape[0], X.shape[1], 1)

    train_size = int(len(X) * 0.8)
    X_train, X_test = X[:train_size], X[train_size:]
    y_train, y_test = y[:train_size], y[train_size:]

    model = build_model(TIME_STEPS)
    model.summary()

    history = model.fit(
        X_train,
        y_train,
        validation_data=(X_test, y_test),
        epochs=15,
        batch_size=32,
        verbose=1,
    )

    model.save("lstm_stock_model.h5")
    joblib.dump(scaler, "scaler.pkl")

    print("Model saved as lstm_stock_model.h5")
    print("Scaler saved as scaler.pkl")

if __name__ == "__main__":
    main()